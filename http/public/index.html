<!DOCTYPE HTML>
<html>
    <head>
        <title>Index</title>
        <link rel="stylesheet" type="text/css" href="/main.css">
        <script>
            window.addEventListener('load', () => {
                const forms = document.querySelectorAll('form')
                forms.forEach((form) => {
                    form.addEventListener('submit',handleSubmit)
                });
            })

            function handleSubmit(e) {
                const $form = document.getElementById(e.target.id);
                const data = new URLSearchParams(new FormData(e.target)); 

                e.preventDefault();
                getErrorBlock(e.target).innerHTML = ''

                fetch(e.target.action,{method:'post',body: data})
                    .then(response => response.json())
                    .then(json => handleResponse(e.target, json))
                    .catch(error => console.error(error))

            }

            function getErrorBlock(form) {
                var b = Array.from(form.children).filter(e => 
                    (e.classList.contains('error-block')))
                return b[0];
            }

            function handleResponse(form, json) {
                if (json.Errors != null) {
                    const e = getErrorBlock(form)
                    const ul = document.createElement('ul');
                    for (const err of json.Errors) {
                        const li = document.createElement('li');
                        li.innerText = err
                        ul.append(li)
                    }
                    e.append(ul);
                }
            }

            function toggle() {
                for (const a of arguments) {
                    const e = document.getElementById(a);
                    if (e.classList.contains('hidden')) {
                        e.classList.remove('hidden')
                    }
                    else {
                        e.classList.add('hidden')
                    }
                }
            }
        </script>
    </head>
    <body>
        <div id="login-block">
            <h2>Log in</h2>
            <form method="post" action="/login">
                <div>
                    <label for="user">User</label><br />
                    <input type="text" name="user" />
                </div>
                <div>
                    <label for="password">Password</label><br />
                    <input type="password" name="password" />
                </div>
                <div class="submit-block">
                    <input type="submit" value="Log In" />
                    <a href="javascript:toggle('login-block','join-block')">Create Account</a>
                </div>
                <div class="error-block">
                </div>
            </form>
        </div>
        <div id="join-block" class="hidden">
            <h2>Create Account</h2>
            <form method="post" action="/join">
                <div>
                    <label for="user">User Name</label><br />
                    <input type="text" name="user" id="user`"/>
                </div>
                <div>
                    <label for="email">Email</label><br />
                    <input type="text" name="email" id="email"/>
                </div>
                <div>
                    <label for="password">Password</label><br />
                    <input type="password" name="password" id="password"/>
                </div>
                <div>
                    <label for="confirm">Confirm Password</label><br />
                    <input type="password" name="confirm" id="confirm"/>
                </div>
                <div class="submit-block">
                    <input type="submit" value="Create Account" />
                    <a href="javascript:toggle('login-block','join-block')">Log In</a>
                </div>
                <div class="error-block">
                </div>
            </form>
        </div>
    </body>
</html>